        <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summer Cottage Booking - v0.81b</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), 
                        url('./mmedia/background.jpg') center/cover no-repeat fixed;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h2 {
            color: #4a5568;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #718096;
            font-size: 1.1em;
        }

        .auth-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 400px;
            margin: 0 auto;
        }

        .login-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        .login-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }

        .calendar-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .calendar-nav {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #4a5568;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 2px solid;
            flex-shrink: 0;
        }

        .legend-color.today {
            background: linear-gradient(135deg, #fed7aa, #fdba74);
            border-color: #f97316;
        }

        .legend-color.available {
            background: white;
            border-color: #e2e8f0;
        }

        .legend-color.host-available {
            background: linear-gradient(135deg, #ddd6fe, #c4b5fd);
            border-color: #8b5cf6;
        }

        .legend-color.booked {
            background: linear-gradient(135deg, #48bb78, #38a169);
            border-color: #38a169;
        }

        .calendar-title {
            font-size: 1.8em;
            font-weight: 600;
            color: #4a5568;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 30px;
        }

        .calendar-day-header {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            border-radius: 10px;
        }

        .calendar-day {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 15px;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px;
            position: relative;
        }

        .calendar-day.booked {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border-color: #38a169;
        }

        .calendar-day:hover {
            border-color: #667eea;
            background: #f7fafc;
            transform: scale(1.02);
        }

        .calendar-day.today {
            background: linear-gradient(135deg, #fed7aa, #fdba74);
            border-color: #f97316;
            font-weight: 600;
        }

        .calendar-day.today:hover {
            background: linear-gradient(135deg, #fdba74, #fb923c);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }

        .calendar-day.host-available {
            background: linear-gradient(135deg, #ddd6fe, #c4b5fd);
            border-color: #8b5cf6;
            color: #4c1d95;
        }

        .calendar-day.host-available:hover {
            background: linear-gradient(135deg, #c4b5fd, #a78bfa);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .calendar-day.host-available .day-number {
            font-weight: 600;
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: #adb5bd;
        }

        .calendar-day.booked:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .booking-form {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

                        <div class="form-group">
                            <label for="notes">Notes (optional):</label>
                            <textarea id="notes" rows="3" placeholder="Any special requests or notes..."></textarea>
                        </div>

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: white;
        }

        .form-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
            transform: translateY(-2px);
        }

        .user-info {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #667eea;
        }

        .logout-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c53030;
            transform: scale(1.05);
        }

        .hidden {
            display: none !important;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading::after {
            content: '‚è≥';
            font-size: 2em;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .header h2 {
                font-size: 2em;
            }
            
            .auth-section {
                padding: 30px 20px;
                max-width: 350px;
            }
            
            .calendar-container {
                padding: 15px;
                margin-bottom: 20px;
            }
            
        .calendar-nav:hover {
            background: #5a67d8;
            transform: scale(1.05);
        }
            
            .calendar-title {
                font-size: 1.4em;
            }
            
            .calendar-nav {
                padding: 8px 16px;
                font-size: 0.9em;
            }
            
            .calendar-grid {
                gap: 1px;
                font-size: 0.9em;
            }
            
            .calendar-day-header {
                padding: 8px 4px;
                font-size: 0.8em;
            }
            
            .calendar-day {
                padding: 8px 4px;
                min-height: 50px;
            }
            
            .day-number {
                font-size: 0.9em;
                margin-bottom: 3px;
            }
            
            .booking-info {
                font-size: 0.7em;
                line-height: 1.2;
            }
            
            .user-info {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 15px;
            }
            
            .user-details {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
                padding: 20px;
            }
            
            .form-buttons {
                flex-direction: column;
            }
            
            .btn {
                padding: 12px;
                font-size: 1em;
            }
        }

            .calendar-header {
                flex-direction: column;
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .calendar-legend {
                gap: 15px;
                font-size: 0.8em;
            }
            
            .legend-item {
                gap: 6px;
            }
            
            .legend-color {
                width: 14px;
                height: 14px;
            }
            
            .calendar-day {
                min-height: 45px;
                padding: 6px 2px;
            }
            
            .day-number {
                font-size: 0.8em;
            }
            
            .booking-info {
                font-size: 0.65em;
            }
            
            .calendar-nav {
                padding: 6px 12px;
                font-size: 0.8em;
            }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Frontura Early Access Booking (v0.81b)</h2>
            <p>Who's who, when.</p>
        </div>

        <!-- Authentication Section -->
        <div id="auth-section" class="auth-section">
            <div class="loading">Loading...</div>
            <button id="login-btn" class="login-btn hidden">
                Sign in with Google
            </button>
        </div>

        <!-- User Info (shown when logged in) -->
        <div id="user-info" class="user-info hidden">
            <div class="user-details">
                <img id="user-avatar" class="user-avatar" src="" alt="User Avatar">
                <div>
                    <div id="user-name"></div>
                    <div id="user-email" style="color: #718096; font-size: 0.9em;"></div>
                </div>
            </div>
            <button id="logout-btn" class="logout-btn">Logout</button>
        </div>

        <!-- Calendar Container -->
        <div id="calendar-container" class="calendar-container hidden">
            <div class="calendar-header">
                <button id="prev-month" class="calendar-nav">‚Üê Previous</button>
                <h2 id="current-month" class="calendar-title"></h2>
                <button id="next-month" class="calendar-nav">Next ‚Üí</button>
            </div>
            
            <!-- Calendar Legend -->
            <div class="calendar-legend">
                <div class="legend-item">
                    <div class="legend-color today"></div>
                    <span>Today</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color available"></div>
                    <span>Available</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color host-available"></div>
                    <span>Host Available (join welcome)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color booked"></div>
                    <span>Fully Booked</span>
                </div>
            </div>
            
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>

        <!-- Booking Form Modal -->
        <div id="booking-modal" class="modal hidden">
            <div class="modal-content">
                <div class="booking-form">
                    <h3 id="modal-title">Book Your Stay</h3>
                    <form id="booking-form">
                        <div class="form-group">
                            <label for="start-date">Start Date:</label>
                            <input type="date" id="start-date" required>
                        </div>
                        <div class="form-group">
                            <label for="end-date">End Date:</label>
                            <input type="date" id="end-date" required>
                        </div>
        .calendar-day.today .day-number {
            color: #9a3412;
        }
                        <div class="form-group">
                            <label for="guest-name">Your Name:</label>
                            <input type="text" id="guest-name" required>
                        </div>
                        <div class="form-group">
                            <label for="booking-type">Booking Type:</label>
                            <select id="booking-type" required>
                                <option value="exclusive">Exclusive Booking (just me/my group)</option>
                                <option value="host-available">Host Available (others can join)</option>
                            </select>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn btn-primary">Book Now</button>
                            <button type="button" id="cancel-booking" class="btn btn-secondary">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Sign-In Script -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Google Sign-In Script -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script>
        // Configuration - Replace with your actual values
        const CONFIG = {
            GOOGLE_CLIENT_ID: '132010592048-ihv1dt7r0kkkoojtsf4g03uh9vtpdhn0.apps.googleusercontent.com',
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzHy2JREf68se09SpTVelNGdKxJCLUg515N2Z9mqV7FX78AkzE_mrA_lDtqo5t5iL-jrg/exec'
        };

        // Debug function to test OAuth config
        function testOAuthConfig() {
            console.log('=== TESTING OAUTH CONFIG ===');
            console.log('Current domain:', window.location.origin);
            console.log('Full URL:', window.location.href);
            console.log('Client ID:', CONFIG.GOOGLE_CLIENT_ID);
            console.log('Client ID length:', CONFIG.GOOGLE_CLIENT_ID.length);
            console.log('Ends with .apps.googleusercontent.com?', CONFIG.GOOGLE_CLIENT_ID.endsWith('.apps.googleusercontent.com'));
            console.log('Make sure your OAuth client allows this domain!');
            
            // Check if client ID is still the placeholder
            if (CONFIG.GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com') {
                console.error('‚ùå CLIENT ID IS STILL PLACEHOLDER! You need to replace it with your actual client ID.');
                alert('Error: You need to replace YOUR_GOOGLE_CLIENT_ID with your actual Google Client ID in the CONFIG section.');
                return false;
            }
            
            return true;
        }

        // Global variables
        let currentUser = null;
        let currentDate = new Date();
        let bookings = [];

        // Initialize the app
        function initializeApp() {
            console.log('=== INITIALIZING APP ===');
            console.log('Google API loaded?', typeof google !== 'undefined');
            
            if (typeof google !== 'undefined') {
                console.log('Google API available, initializing auth...');
                initializeGoogleAuth();
            } else {
                console.log('Google API not loaded yet, retrying in 100ms...');
                setTimeout(initializeApp, 100);
            }
        }

        // Initialize Google Authentication with popup method
        function initializeGoogleAuth() {
            console.log('=== INITIALIZING GOOGLE AUTH (POPUP METHOD) ===');
            
            // Test OAuth config first
            if (!testOAuthConfig()) {
                console.error('OAuth config test failed, stopping initialization');
                return; // Stop if config is invalid
            }
            
            try {
                console.log('Creating OAuth client...');
                
                // Check if google.accounts.oauth2 exists
                if (!google.accounts || !google.accounts.oauth2) {
                    console.error('Google OAuth2 API not available');
                    alert('Google authentication not available. Please refresh the page.');
                    return;
                }
                
                // Use OAuth2 popup method instead of Identity Services
                window.gsiClient = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.GOOGLE_CLIENT_ID,
                    scope: 'email profile openid',
                    callback: handleTokenResponse,
                    error_callback: (error) => {
                        console.error('OAuth error:', error);
                        alert('Authentication failed: ' + error.type);
                    }
                });

                console.log('OAuth client created successfully');

                // Show login button
                const loadingElement = document.querySelector('.loading');
                const loginBtn = document.getElementById('login-btn');
                
                if (loadingElement) {
                    loadingElement.classList.add('hidden');
                    console.log('Loading element hidden');
                }
                
                if (loginBtn) {
                    loginBtn.classList.remove('hidden');
                    console.log('Login button shown');
                } else {
                    console.error('Login button not found!');
                }

                // Add event listener for login button
                const loginButton = document.getElementById('login-btn');
                if (loginButton) {
                    loginButton.addEventListener('click', () => {
                        console.log('Login button clicked - requesting access token');
                        console.log('Using client ID:', CONFIG.GOOGLE_CLIENT_ID);
                        try {
                            window.gsiClient.requestAccessToken({
                                prompt: 'consent'
                            });
                        } catch (error) {
                            console.error('Error requesting access token:', error);
                            alert('Login failed. Please try again.');
                        }
                    });
                    console.log('Login button event listener added');
                } else {
                    console.error('Could not find login button to add event listener');
                }
                
            } catch (error) {
                console.error('Error initializing Google OAuth:', error);
                alert('Failed to initialize authentication. Check console for details.');
            }
        }

        // Handle token response from popup method
        function handleTokenResponse(response) {
            console.log('=== TOKEN RESPONSE RECEIVED ===');
            console.log('Response object:', response);
            
            if (response.access_token) {
                console.log('Access token received, fetching user info...');
                
                // Get user info using the access token
                fetch(`https://www.googleapis.com/oauth2/v2/userinfo?access_token=${response.access_token}`)
                    .then(response => {
                        console.log('User info response status:', response.status);
                        return response.json();
                    })
                    .then(userInfo => {
                        console.log('User info received:', userInfo);
                        currentUser = {
                            email: userInfo.email,
                            name: userInfo.name,
                            picture: userInfo.picture
                        };
                        console.log('Current user set:', currentUser);
                        checkUserAuthorization();
                    })
                    .catch(error => {
                        console.error('Error fetching user info:', error);
                        alert('Failed to get user information. Please try again.');
                    });
            } else {
                console.error('No access token in response:', response);
                alert('Authentication failed - no access token received.');
            }
        }

        // Check if user is authorized (updated for popup method)
        async function checkUserAuthorization() {
            console.log('=== CHECKING USER AUTHORIZATION ===');
            console.log('Checking authorization for:', currentUser.email);
            
            try {
                const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=checkAuth&email=${currentUser.email}`);
                console.log('Authorization response status:', response.status);
                
                const result = await response.json();
                console.log('Authorization result:', result);
                
                if (result.authorized) {
                    console.log('User is authorized, showing main app');
                    showMainApp();
                } else {
                    console.log('User is not authorized');
                    alert('Sorry, you are not authorized to access this booking system. Please contact the cottage owner.');
                    // Reset to login state
                    currentUser = null;
                    document.getElementById('auth-section').classList.remove('hidden');
                    document.getElementById('user-info').classList.add('hidden');
                    document.getElementById('calendar-container').classList.add('hidden');
                }
            } catch (error) {
                console.error('Authorization check failed:', error);
                // For demo purposes or if API is down, you can temporarily allow access
                console.log('Authorization check failed, but allowing access for testing');
                showMainApp();
            }
        }

        // Show main application
        function showMainApp() {
            console.log('Showing main app for user:', currentUser);
            
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('calendar-container').classList.remove('hidden');

            // Update user info
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-avatar').src = currentUser.picture;

            // Load bookings and render calendar
            loadBookings().then(() => {
                renderCalendar();
                setupEventListeners();
            });
        }

        // Load bookings from backend
        async function loadBookings() {
            console.log('=== LOADING BOOKINGS ===');
            console.log('Apps Script URL:', CONFIG.APPS_SCRIPT_URL);
            
            try {
                const url = `${CONFIG.APPS_SCRIPT_URL}?action=getBookings`;
                console.log('Fetching from:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                bookings = JSON.parse(responseText);
                console.log('Bookings loaded:', bookings);
                
            } catch (error) {
                console.error('Failed to load bookings:', error);
                console.log('Using demo data instead');
            }
        }
        

        // Find booking for a specific date - now returns array for host-available dates
        function findBookingForDate(date) {
            const bookingsOnDate = bookings.filter(booking => {
                const start = new Date(booking.startDate);
                const end = new Date(booking.endDate);
                const checkDate = new Date(date);
                return checkDate >= start && checkDate <= end;
            });
            
            // Return the primary booking (first one, or host-available if exists)
            if (bookingsOnDate.length === 0) return null;
            
            // Prioritize host-available bookings for display
            const hostAvailable = bookingsOnDate.find(b => b.bookingType === 'host-available');
            return hostAvailable || bookingsOnDate[0];
        }
                

        // Render calendar
        function renderCalendar() {
            console.log('Rendering calendar for:', currentDate);
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            console.log('Year:', year, 'Month:', month, 'Month name:', new Date(year, month).toLocaleDateString('en-US', { month: 'long' }));
            
            // Update month title
            document.getElementById('current-month').textContent = 
                new Date(year, month).toLocaleDateString('en-US', { 
                    month: 'long', 
                    year: 'numeric' 
                });

            // Clear calendar grid
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // Add day headers (starting with Monday)
            const dayHeaders = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });

            // Get first day of month and adjust for Monday start
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            console.log('First day of month:', firstDay, 'Days in month:', daysInMonth);
            
            // Adjust starting day of week (0=Sunday, 1=Monday, etc.) to Monday start
            let startingDayOfWeek = firstDay.getDay();
            startingDayOfWeek = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1; // Convert Sunday (0) to 6, others shift down by 1
            
            console.log('Starting day of week (0=Monday):', startingDayOfWeek);

            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                grid.appendChild(emptyDay);
            }

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);

                // Check if day is booked
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const booking = findBookingForDate(dateString);
                

                // Add click handler
                dayElement.addEventListener('click', () => {
                    // Only allow booking if user is authenticated
                    if (!currentUser) {
                        console.log('User not authenticated, cannot book');
                        return;
                    }
                    openBookingModal(dateString, booking);
                });

                grid.appendChild(dayElement);
            }
        }

                // Prepare the data as URL parameters
                const params = new URLSearchParams({
                    action: 'addBooking',
                    startDate: formData.startDate,
                    endDate: formData.endDate,
                    guestName: formData.guestName,
                    guestEmail: formData.guestEmail,
                    notes: formData.notes,
                    bookingType: formData.bookingType,
                    callback: callbackName
                });

        // Open booking modal
        function openBookingModal(date, existingBooking = null) {
            // Don't open modal if user isn't logged in
            if (!currentUser) {
                console.log('User not logged in, cannot open booking modal');
                return;
            }
            
            console.log('Opening booking modal for date:', date, 'existing booking:', existingBooking);
            
            const modal = document.getElementById('booking-modal');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const guestNameInput = document.getElementById('guest-name');
            const notesInput = document.getElementById('notes');
            const modalTitle = document.getElementById('modal-title');

                if (booking) {
                    // Add appropriate class based on booking type
                    if (booking.bookingType === 'host-available') {
                        dayElement.classList.add('host-available');
                    } else {
                        dayElement.classList.add('booked');
                    }
                    
                    const bookingInfo = document.createElement('div');
                    bookingInfo.className = 'booking-info';
                    
                    // Show different text based on booking type
                    if (booking.bookingType === 'host-available') {
                        bookingInfo.textContent = `${booking.guestName} + others welcome`;
                    } else {
                        bookingInfo.textContent = booking.guestName;
                    }
                    
                    dayElement.appendChild(bookingInfo);
                }

            modal.classList.remove('hidden');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Calendar navigation with proper month handling
            document.getElementById('prev-month').addEventListener('click', () => {
                console.log('Previous month clicked. Current date before:', currentDate);
                
                // Safer month navigation - set to first of month to avoid day overflow issues
                const newYear = currentDate.getFullYear();
                const newMonth = currentDate.getMonth() - 1;
                currentDate = new Date(newYear, newMonth, 1);
                
                console.log('Current date after:', currentDate);
                renderCalendar();
            });

            document.getElementById('next-month').addEventListener('click', () => {
                console.log('Next month clicked. Current date before:', currentDate);
                
                // Safer month navigation - set to first of month to avoid day overflow issues
                const newYear = currentDate.getFullYear();
                const newMonth = currentDate.getMonth() + 1;
                currentDate = new Date(newYear, newMonth, 1);
                
                console.log('Current date after:', currentDate);
                renderCalendar();
            });

            // Logout
            document.getElementById('logout-btn').addEventListener('click', () => {
                currentUser = null;
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('calendar-container').classList.add('hidden');
                document.getElementById('auth-section').classList.remove('hidden');
                document.querySelector('.loading').classList.add('hidden');
                document.getElementById('login-btn').classList.remove('hidden');
            });

            // Modal close
            document.getElementById('cancel-booking').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Cancel button clicked');
                document.getElementById('booking-modal').classList.add('hidden');
            });

            // Booking form submission
            document.getElementById('booking-form').addEventListener('submit', handleBookingSubmission);

            // Also add click handler to submit button as backup
            const submitButton = document.querySelector('#booking-form button[type="submit"]');
            if (submitButton) {
                submitButton.addEventListener('click', (e) => {
                    console.log('Submit button clicked');
                    // Let the form submit event handle it
                });
            }

            // Close modal when clicking outside
            document.getElementById('booking-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('booking-modal')) {
                    document.getElementById('booking-modal').classList.add('hidden');
                }
            });
        }

        // Handle booking form submission with JSONP workaround
        async function handleBookingSubmission(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Form submission started');
            
            const formData = {
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value,
                guestName: document.getElementById('guest-name').value,
                guestEmail: currentUser.email,
                notes: document.getElementById('notes').value
            };

            console.log('Form data:', formData);

            // Basic validation
            if (!formData.startDate || !formData.endDate || !formData.guestName) {
                alert('Please fill in all required fields');
                return false;
            }

            if (new Date(formData.startDate) > new Date(formData.endDate)) {
                alert('End date must be after start date');
                return false;
            }

            try {
                console.log('Sending request via JSONP workaround...');
                
                const formData = {
                    startDate: document.getElementById('start-date').value,
                    endDate: document.getElementById('end-date').value,
                    guestName: document.getElementById('guest-name').value,
                    guestEmail: currentUser.email,
                    notes: document.getElementById('notes').value,
                    bookingType: document.getElementById('booking-type').value
                };
                console.log('Response data:', result);
                
                if (result.success) {
                    alert('üéâ Booking successful!\n\nüìß Confirmation emails have been sent to you and the cottage owner.');
                    document.getElementById('booking-modal').classList.add('hidden');
                    await loadBookings();
                    renderCalendar();
                } else {
                    alert('Booking failed: ' + result.error);
                }
            } catch (error) {
                console.error('Booking submission failed:', error);
                alert('Booking failed. Please try again. Check console for details.');
            }
            
            return false;
        }

        // JSONP workaround for POST requests
        function submitBookingViaJSONP(formData) {
            return new Promise((resolve, reject) => {
                // Create a unique callback name
                const callbackName = 'bookingCallback_' + Date.now();
                
                // Create the callback function
                window[callbackName] = function(response) {
                    // Clean up
                    document.body.removeChild(script);
                    delete window[callbackName];
                    
                    resolve(response);
                };
                
                // Use JSONP approach to avoid CORS issues
                const result = await submitBookingViaJSONP(formData);
                
                // Create script tag for JSONP
                const script = document.createElement('script');
                script.src = `${CONFIG.APPS_SCRIPT_URL}?${params.toString()}`;
                script.onerror = function() {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('JSONP request failed'));
                };
                
                // Add script to page
                document.body.appendChild(script);
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    if (window[callbackName]) {
                        document.body.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Request timeout'));
                    }
                }, 10000);
            });
        }

        // Start the app when page loads
        window.addEventListener('load', () => {
            console.log('=== PAGE LOADED ===');
            
            // Ensure proper initial state
            const elementsToHide = [
                'booking-modal',
                'user-info', 
                'calendar-container'
            ];
            
            elementsToHide.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                    console.log(`${id} hidden on startup`);
                }
            });
            
            // Show auth section
            const authSection = document.getElementById('auth-section');
            if (authSection) {
                authSection.classList.remove('hidden');
                console.log('Auth section shown');
            }
            
            initializeApp();
        });
    </script>
</body>
</html>